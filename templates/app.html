<!DOCTYPE html>
<html>
<head>
  <title>lyrX</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root {
      background-color: rgb(14, 14, 14);
      color: gray;
      font-family: Inter, Arial;
      text-align: center;
      font-weight: 300;
    }
    /* Container for full screen layout */
    #content {
      width: 100%;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }
    /* Lyrics container centers its content vertically */
    #lyrics-container {
      width: 100%;
      height: 90%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    /* The lyric lines */
    #lyrics p {
      font-size: 48px;
      margin: 5px 0;
    }
    /* All lyrics gray */
    .lyric {
      color: rgb(196, 196, 196);
    }
    /* Optional: current lyric bolded */
    #current-lyric, #past-lyric {
      font-weight: bold;
      color: white;
    }
    /* Song title at bottom */
    #song-title {
      position: absolute;
      left: 300px;
      bottom: 150px;
      font-weight: 1000;
      text-align: left;
      font-size: 38px;
      color: rgb(255, 255, 255);
    }
    #song-artists {
      position: absolute;
      left: 300px;
      bottom: 200px;
      font-weight: 300;
      text-align: left;
      font-size: 24px;
      color: rgb(255, 255, 255);
    }
    html, body {margin: 0; height: 100%; overflow: hidden}
    #status{
      position: absolute;
      left:300px;
      bottom: 40px;
      width: 100%; 
      text-align: left;
      font-size: 20px;
      color: rgb(255, 255, 255);
      opacity: 0.4;
    }
    #current-lyric {
    transition: transform 0.5s ease, opacity 0.5s ease;
    }
    .slide-out {
    transform: translateY(-20px);
    opacity: 0;
    }
    #pfp{
      width: 24px;
      height: 24px;
      left: 40px;
      text-align: left;
      border-radius: 25px;
      top: 25px;
      position: absolute;
    }
    #username{
      left: 75px;
      color: #fff;
      text-align: left;
      font-weight: 800;
      top: 12px;
      position: absolute;
    }
  </style>
</head>
<body>
  <div id="content">
    <div id="user">
      <img id="pfp">
      <p id="username">Logged out, redirecting to login...</p>
    </div>
    <div id="lyrics-container">
      <div id="lyrics">
        <p id="past-lyrics" class="lyric"></p>
        <p id="current-lyric" class="lyric"></p>
        <p id="future-lyrics" class="lyric"></p>
      </div>
    </div>
    <img id="song-cover" style="position: absolute; bottom: 50px; left: 50px; width: 200px; height: 200px; object-fit: cover; border-radius: 10px; border:solid 0px trana;">
    <div id="song-title">Nothing's playing right now.</div>
    <div id="song-artists"></div>
    <p id="status"></p>
  </div>

  <script>
    let lastTrackId = null;
    let currentLyrics = null;
    let estimatedProgress = 0;
    let lastSyncTime = 0;
    let isPlaying = false;

    // These functions assume your API returns lyrics in an object with keys as timestamps (ms)
    // e.g., { "0": "First line", "5000": "Second line", "10000": "Third line" }

    function storeToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      if (token) {
        localStorage.setItem("spotify_token", token);
        window.history.replaceState({}, document.title, "/app");
        fetchUserProfile();
        fetchCurrentlyPlaying();
      }
    }

    function fetchUserProfile() {
      const token = localStorage.getItem("spotify_token");
      if (!token) return;

      fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(response => {
        if (response.status === 401) {
          window.location.href = "/spotify/login";
        }
        return response.json();
      })
      .then(data => {
        console.log("User:", data.display_name);
        document.getElementById('username').textContent = data.display_name;
        document.getElementById('pfp').src = data.images[0]?.url || 'default-profile-image.png';
      })
      .catch(error => console.error("Error fetching user profile:", error));
    }

    async function getDataOfTrack(trackName) {
      try {
        const response = await fetch(`/api/search?q=!${encodeURIComponent(trackName)}`);
        const data = await response.json();
        return (data && data.length > 0) ? data[0] : null;
      } catch (error) {
        console.error("Error searching track:", error);
        return null;
      }
    }

    async function fetchCurrentlyPlaying() {
      const token = localStorage.getItem("spotify_token");
      if (!token) return;

      fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(response => {
        if (response.status === 401) {
          window.location.href = "/spotify/login";
        }
        return response.json();
      })
      .then(async data => {
        if (data && data.item) {
          const currentTrackId = data.item.id;
          isPlaying = data.is_playing;
          estimatedProgress = data.progress_ms;
          lastSyncTime = Date.now();
          if (data.item.album.images.length > 0) {
            const coverImage = document.getElementById("song-cover");
            coverImage.src = data.item.album.images[0].url;
          }

          const songTitleElement = document.getElementById("song-title");
          if (songTitleElement) {
            songTitleElement.innerHTML =
              `${data.item.name}`;
          }
          const songArtistsElement = document.getElementById("song-artists");
          if (songArtistsElement) {
            songArtistsElement.innerHTML =
              `${data.item.artists.map(artist => artist.name).join(", ")}`;
          }

          if (currentTrackId !== lastTrackId) {
            lastTrackId = currentTrackId;
            const lyrxData = await getDataOfTrack(data.item.name);
            if (lyrxData) {
                document.getElementById("status").textContent = `#${lyrxData.id}`;
              document.getElementById("lyrics").style.display = "block";
              await loadLyrics(lyrxData.id, estimatedProgress);
            } else {
              document.getElementById("status").innerHTML = `lyrX does not have this track registered. <a>Request a track</a>`;
              document.getElementById("lyrics").style.display = "none";
              currentLyrics = null;
            }
          }
        } else {
          lastTrackId = null;
          isPlaying = false;
          document.getElementById("song-title").textContent = "No track currently playing.";
          document.getElementById("lyrics").style.display = "none";
        }
      })
      .catch(error => {
        console.error("Error fetching currently playing track:", error);
        if (error.response && error.response.status === 401) {
          window.location.href = "/spotify/login";
        }
      });
    }

    async function loadLyrics(id, initialProgress) {
      const lyricsDiv = document.getElementById("lyrics");
      try {
        const response = await fetch(`/api/track/${id}/json`);
        if (!response.ok) throw new Error("Failed to fetch lyrics");

        currentLyrics = await response.json();
        estimatedProgress = initialProgress;
        lastSyncTime = Date.now();
        // Update the fixed lyric lines
        updateLyrics();
      } catch (error) {
        console.error("Error loading lyrics:", error);
      }
    }

    function updateLyrics() {
      if (!currentLyrics || !isPlaying) return;

      let elapsedTime = Date.now() - lastSyncTime;
      let progress = estimatedProgress + elapsedTime;
      const timestamps = Object.keys(currentLyrics).map(Number).sort((a, b) => a - b);
      
      // Find the index of the last timestamp that is <= progress.
      let currentIndex = -1;
      for (let i = 0; i < timestamps.length; i++) {
        if (timestamps[i] <= progress) {
          currentIndex = i;
        } else {
          break;
        }
      }

      let pastText = "";
      let currentText = "";
      let futureText = "";
      
      // Gather past 5 lyrics
      let pastLyrics = [];
      for (let i = currentIndex - 3; i <= currentIndex - 1; i++) {
        if (i >= 0) {
          pastLyrics.push(currentLyrics[timestamps[i]]);
        }
      }
      currentText = currentLyrics[timestamps[currentIndex]];
      let futureLyrics = [];
      for (let i = currentIndex + 1; i <= currentIndex + 3; i++) {
        if (i < timestamps.length) {
          futureLyrics.push(currentLyrics[timestamps[i]]);
        }
      }

      document.getElementById("past-lyrics").innerHTML = pastLyrics.join("<br>");
      document.getElementById("current-lyric").textContent = currentText;
      document.getElementById("future-lyrics").innerHTML = futureLyrics.join("<br>");
    }

    async function main() {
      storeToken();
      fetchUserProfile();
      await fetchCurrentlyPlaying();
      setInterval(() => {
        if (isPlaying) {
          updateLyrics();
        }
      }, 100);
      setInterval(async () => {
        await fetchCurrentlyPlaying();
      }, 1000);
    }
    function updateCurrentLyric(newLyric) {
        const lyricEl = document.getElementById('current-lyric');
        lyricEl.classList.add('slide-out');
        setTimeout(() => {
            lyricEl.textContent = newLyric;
            lyricEl.classList.remove('slide-out');
        }, 500);
    }

    document.addEventListener("DOMContentLoaded", main);
  </script>
</body>
</html>
